<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DEV-TOOL-KIT-A2A - Build Your App</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 400px 1fr;
      height: 100vh;
      gap: 0;
    }

    /* Left Side - Progress & Chat */
    .left-panel {
      background: white;
      border-right: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .header {
      padding: 24px;
      border-bottom: 1px solid #e0e0e0;
    }

    .header h1 {
      font-size: 20px;
      color: #333;
      margin-bottom: 4px;
    }

    .header p {
      font-size: 14px;
      color: #666;
    }

    /* Progress Tracker */
    .progress-section {
      padding: 24px;
      border-bottom: 1px solid #e0e0e0;
    }

    .progress-title {
      font-size: 12px;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 16px;
    }

    .progress-steps {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .progress-step {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .progress-step.pending {
      background: #f5f7fa;
    }

    .progress-step.active {
      background: #e3f2fd;
      border-left: 3px solid #667eea;
    }

    .progress-step.complete {
      background: #e8f5e9;
      border-left: 3px solid #4caf50;
    }

    .step-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }

    .progress-step.pending .step-icon {
      background: #e0e0e0;
      color: #999;
    }

    .progress-step.active .step-icon {
      background: #667eea;
      color: white;
    }

    .progress-step.complete .step-icon {
      background: #4caf50;
      color: white;
    }

    .step-info {
      flex: 1;
    }

    .step-name {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }

    .step-desc {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }

    /* Chat Area */
    .chat-area {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .message {
      display: flex;
      gap: 12px;
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }

    .message-avatar.bot {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .message-avatar.user {
      background: #e0e0e0;
    }

    .message-content {
      flex: 1;
    }

    .message-text {
      background: #f5f7fa;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.6;
      color: #333;
    }

    .message.bot .message-text {
      background: #f5f7fa;
    }

    .message.user .message-text {
      background: #667eea;
      color: white;
    }

    .message-time {
      font-size: 11px;
      color: #999;
      margin-top: 4px;
      padding-left: 4px;
    }

    /* Right Side - Preview */
    .right-panel {
      background: #1e1e1e;
      display: flex;
      flex-direction: column;
    }

    .preview-header {
      background: #2d2d2d;
      padding: 16px 24px;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .preview-title {
      color: white;
      font-size: 14px;
      font-weight: 600;
    }

    .device-selector {
      display: flex;
      gap: 8px;
    }

    .device-btn {
      background: #3d3d3d;
      color: #ccc;
      border: 1px solid #555;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .device-btn:hover {
      background: #4d4d4d;
      color: white;
    }

    .device-btn.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    .preview-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      overflow: auto;
      background: #252525;
    }

    .preview-empty {
      text-align: center;
      color: #888;
    }

    .preview-empty-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    .preview-frame-wrapper {
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      transition: all 0.3s ease;
      overflow: hidden;
    }

    .preview-frame-wrapper.desktop {
      width: 100%;
      height: 100%;
    }

    .preview-frame-wrapper.mobile {
      width: 375px;
      height: 667px;
      max-height: 90%;
    }

    .preview-frame {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* Input Area */
    .input-area {
      padding: 20px 24px;
      border-top: 1px solid #e0e0e0;
      background: white;
    }

    .input-wrapper {
      display: flex;
      gap: 12px;
    }

    textarea {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 14px;
      font-family: inherit;
      resize: none;
      min-height: 44px;
      max-height: 120px;
    }

    textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #f5f7fa;
    }

    /* Plan Card */
    .plan-card {
      background: white;
      border: 2px solid #667eea;
      border-radius: 12px;
      padding: 20px;
      margin: 16px 0;
    }

    .plan-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .plan-content {
      font-size: 14px;
      line-height: 1.6;
      color: #666;
      margin-bottom: 16px;
    }

    .plan-actions {
      display: flex;
      gap: 8px;
    }

    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* API Config Button */
    .config-link {
      font-size: 12px;
      color: #667eea;
      text-decoration: none;
      padding: 8px 12px;
      border-radius: 6px;
      background: #f5f7fa;
      display: inline-block;
      margin-top: 8px;
    }

    .config-link:hover {
      background: #e3f2fd;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Left Panel - Progress & Chat -->
    <div class="left-panel">
      <div class="header">
        <h1>üöÄ Build Your App</h1>
        <p>AI-powered development assistant</p>
      </div>

      <!-- Progress Tracker -->
      <div class="progress-section">
        <div class="progress-title">Build Progress</div>
        <div class="progress-steps" id="progressSteps">
          <div class="progress-step pending" id="step-discover">
            <div class="step-icon">1</div>
            <div class="step-info">
              <div class="step-name">Discovery</div>
              <div class="step-desc">Understanding your vision</div>
            </div>
          </div>
          <div class="progress-step pending" id="step-plan">
            <div class="step-icon">2</div>
            <div class="step-info">
              <div class="step-name">Planning</div>
              <div class="step-desc">Creating the blueprint</div>
            </div>
          </div>
          <div class="progress-step pending" id="step-design">
            <div class="step-icon">3</div>
            <div class="step-info">
              <div class="step-name">Design</div>
              <div class="step-desc">Architecting the solution</div>
            </div>
          </div>
          <div class="progress-step pending" id="step-build">
            <div class="step-icon">4</div>
            <div class="step-info">
              <div class="step-name">Building</div>
              <div class="step-desc">Writing the code</div>
            </div>
          </div>
          <div class="progress-step pending" id="step-review">
            <div class="step-icon">5</div>
            <div class="step-info">
              <div class="step-name">Review</div>
              <div class="step-desc">Testing & refinement</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Chat Area -->
      <div class="chat-area" id="chatArea">
        <div class="message bot">
          <div class="message-avatar bot">ü§ñ</div>
          <div class="message-content">
            <div class="message-text">
              Hi! I'm your AI development assistant. üëã
              <br><br>
              I'll help you build your application through a conversational process. I'll ask questions to understand your needs, suggest features you might not have thought of, and create exactly what you envision.
              <br><br>
              <strong>What would you like to build today?</strong>
              <br>
              <em>(e.g., "A restaurant finder app", "An e-commerce store for handmade jewelry", "A real-time chat app for gamers")</em>
            </div>
            <div class="message-time">Just now</div>
          </div>
        </div>
      </div>

      <!-- Input Area -->
      <div class="input-area">
        <div class="input-wrapper">
          <textarea
            id="userInput"
            placeholder="Describe your app idea..."
            rows="1"
          ></textarea>
          <button class="btn-primary" id="sendBtn" onclick="sendMessage()">
            Send
          </button>
        </div>
      </div>
    </div>

    <!-- Right Panel - Preview -->
    <div class="right-panel">
      <div class="preview-header">
        <div class="preview-title">üëÅÔ∏è Live Preview</div>
        <div class="device-selector">
          <button class="device-btn active" onclick="setDevice('desktop')" id="btn-desktop">
            üñ•Ô∏è Desktop
          </button>
          <button class="device-btn" onclick="setDevice('mobile')" id="btn-mobile">
            üì± Mobile
          </button>
        </div>
      </div>
      <div class="preview-container" id="previewContainer">
        <div class="preview-empty">
          <div class="preview-empty-icon">üì±</div>
          <p>Your app preview will appear here</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentStep = 'discover';
    let currentDevice = 'desktop';
    let workflowId = null;
    let discoveryQuestions = 0;
    let conversationState = {
      initialDescription: null,
      fullDescription: '',
      features: [],
      targetUsers: null,
      planApproved: false,
      designComplete: false,
      codeGenerated: false,
      canModify: true
    };

    // Auto-resize textarea
    document.getElementById('userInput').addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
    });

    // Send message on Enter (Shift+Enter for new line)
    document.getElementById('userInput').addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    async function sendMessage() {
      const input = document.getElementById('userInput');
      const message = input.value.trim();

      if (!message) return;

      // Clear input
      input.value = '';
      input.style.height = 'auto';

      // Add user message to chat
      addMessage('user', message);

      // Disable send button
      const sendBtn = document.getElementById('sendBtn');
      sendBtn.disabled = true;
      sendBtn.innerHTML = '<span class="loading-spinner"></span>';

      // Process based on current step
      if (currentStep === 'discover') {
        await handleDiscovery(message);
      } else if (currentStep === 'plan') {
        await handlePlanApproval(message);
      } else if (currentStep === 'design') {
        await handleDesign();
      } else if (currentStep === 'build') {
        await handleBuild();
      } else if (currentStep === 'modify') {
        await handleModification(message);
      } else if (currentStep === 'review') {
        await handleReviewChat(message);
      }

      // Re-enable send button
      sendBtn.disabled = false;
      sendBtn.innerHTML = 'Send';
    }

    async function handleDiscovery(message) {
      if (!conversationState.initialDescription) {
        // First message - store initial description
        conversationState.initialDescription = message;
        conversationState.fullDescription = message;

        await sleep(800);

        // Detect app type and suggest features
        const suggestions = analyzeAndSuggestFeatures(message);

        if (suggestions.length > 0) {
          addMessage('bot', `Interesting! A ${suggestions.appType || 'web application'}. I have some suggestions to make it even better:`);

          await sleep(600);

          const suggestionsList = suggestions.map((s, i) => `${i + 1}. ${s}`).join('<br>');
          addMessage('bot', suggestionsList);

          await sleep(800);
        }

        // Ask follow-up questions
        discoveryQuestions++;
        await sleep(500);
        addMessage('bot', `To build something perfect for you, I have a few questions:<br><br>` +
          `1. Who is your target audience?<br>` +
          `2. Do you need any specific integrations? (maps, payments, social media, etc.)<br>` +
          `3. What's the primary goal users should accomplish?`);

      } else if (discoveryQuestions === 1) {
        // Second round - gather more details
        conversationState.fullDescription += '\n\nAdditional context: ' + message;
        discoveryQuestions++;

        await sleep(600);
        addMessage('bot', 'Great context! Is there anything else important I should know before I create the plan?');

        await sleep(400);
        addMessage('bot', '(You can type "ready" to proceed to planning, or tell me more)');

      } else {
        // Final round or "ready" command
        if (message.toLowerCase().includes('ready') || message.toLowerCase().includes('proceed') ||
            message.toLowerCase().includes("let's go") || message.toLowerCase().includes('build')) {
          await moveToPlanningPhase();
        } else {
          conversationState.fullDescription += '\n\n' + message;
          discoveryQuestions++;

          await sleep(600);
          addMessage('bot', 'Got it! Anything else, or are you ready for me to create a detailed plan?');
        }
      }
    }

    function analyzeAndSuggestFeatures(description) {
      const lower = description.toLowerCase();
      const suggestions = [];
      suggestions.appType = null;

      // Detect app type and suggest relevant features
      if (lower.includes('restaurant') || lower.includes('food') || lower.includes('dining')) {
        suggestions.appType = 'restaurant finder app';
        suggestions.push('üó∫Ô∏è **Interactive Map** - Show restaurants on a map with your current location');
        suggestions.push('‚≠ê **Reviews Integration** - Pull real reviews from Yelp and Google');
        suggestions.push('üì∏ **Photo Gallery** - Display restaurant photos in a beautiful gallery');
        suggestions.push('üìç **Distance Calculator** - Show how far each restaurant is from you');
        suggestions.push('üìÖ **Reservation System** - Let users book tables directly');
        suggestions.push('üîç **Advanced Filters** - Search by cuisine, price, rating, distance');
      } else if (lower.includes('shop') || lower.includes('ecommerce') || lower.includes('store')) {
        suggestions.appType = 'e-commerce platform';
        suggestions.push('üí≥ **Payment Processing** - Integrate Stripe for secure payments');
        suggestions.push('üõí **Shopping Cart** - Persistent cart with local storage');
        suggestions.push('‚≠ê **Product Reviews** - Let customers leave ratings and reviews');
        suggestions.push('üìß **Email Notifications** - Order confirmations and shipping updates');
        suggestions.push('üîê **User Accounts** - Save addresses and order history');
      } else if (lower.includes('social') || lower.includes('community') || lower.includes('chat')) {
        suggestions.appType = 'social platform';
        suggestions.push('üë§ **User Profiles** - Customizable profiles with avatars');
        suggestions.push('üí¨ **Real-time Chat** - WebSocket-based messaging');
        suggestions.push('üì∏ **Image Uploads** - Share photos and media');
        suggestions.push('üëç **Likes & Comments** - Engagement features');
        suggestions.push('üîî **Notifications** - Real-time activity updates');
      } else if (lower.includes('blog') || lower.includes('content') || lower.includes('article')) {
        suggestions.appType = 'content platform';
        suggestions.push('‚úçÔ∏è **Rich Text Editor** - Format posts with markdown');
        suggestions.push('üè∑Ô∏è **Tags & Categories** - Organize content');
        suggestions.push('üí¨ **Comments System** - Engage with readers');
        suggestions.push('üì± **Responsive Design** - Perfect on all devices');
        suggestions.push('üîç **Search Functionality** - Find content easily');
      } else if (lower.includes('dashboard') || lower.includes('analytics') || lower.includes('data')) {
        suggestions.appType = 'data dashboard';
        suggestions.push('üìä **Interactive Charts** - Visualize data beautifully');
        suggestions.push('üîÑ **Real-time Updates** - Live data refreshing');
        suggestions.push('üì• **Data Export** - Download reports as CSV/PDF');
        suggestions.push('üéØ **Custom Filters** - Slice and dice your data');
        suggestions.push('üìß **Automated Reports** - Scheduled email summaries');
      }

      return suggestions;
    }

    async function moveToPlanningPhase() {
      // Update progress
      updateProgress('discover', 'complete');
      updateProgress('plan', 'active');
      currentStep = 'plan';

      await sleep(800);
      addMessage('bot', `Perfect! Let me analyze everything you've told me and create a comprehensive plan...`);

      await sleep(1500);

      // Generate plan with AI
      try {
        const response = await fetch('/api/workflow/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ description: conversationState.fullDescription })
        });

        const data = await response.json();

        if (data.success) {
          workflowId = data.workflowId;

          addMessage('bot', `I've created a detailed plan based on our conversation:`, {
            type: 'plan',
            content: `
              <div class="plan-card">
                <div class="plan-title">üìã Development Plan</div>
                <div class="plan-content">
                  <strong>Project:</strong> ${conversationState.initialDescription}
                  <br><br>
                  <strong>Core Features:</strong>
                  <br>‚Ä¢ Responsive web application (mobile & desktop)
                  <br>‚Ä¢ Modern, clean UI with smooth animations
                  <br>‚Ä¢ Full functionality based on your requirements
                  <br><br>
                  <strong>Technical Stack:</strong>
                  <br>‚Ä¢ HTML5, CSS3, JavaScript
                  <br>‚Ä¢ No external dependencies - works immediately
                  <br>‚Ä¢ SEO-friendly and performant
                  <br><br>
                  <strong>Deliverable:</strong> A production-ready application you can deploy right away.
                </div>
                <div class="plan-actions">
                  <button class="btn-primary" onclick="approvePlan()">‚úì Let's Build This!</button>
                  <button class="btn-secondary" onclick="rejectPlan()">‚úèÔ∏è I Want Changes</button>
                </div>
              </div>
            `
          });
        }
      } catch (error) {
        addMessage('bot', `Sorry, I encountered an error: ${error.message}`);
      }
    }

    async function approvePlan() {
      conversationState.planApproved = true;

      addMessage('user', 'Looks good! Let\'s proceed.');

      updateProgress('plan', 'complete');
      updateProgress('design', 'active');
      currentStep = 'design';

      await sleep(800);
      addMessage('bot', 'Perfect! I\'ll start designing the architecture now. This will take a moment...');

      // Auto-proceed to design
      await handleDesign();
    }

    function rejectPlan() {
      addMessage('user', 'Let\'s adjust the plan.');
      addMessage('bot', 'No problem! What would you like to change about the plan?');
      updateProgress('plan', 'pending');
      currentStep = 'discover';
    }

    async function handleDesign() {
      try {
        const response = await fetch('/api/workflow/execute-phase', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            workflowId: workflowId,
            phase: 'design'
          })
        });

        const data = await response.json();

        if (data.success) {
          conversationState.designComplete = true;
          updateProgress('design', 'complete');
          updateProgress('build', 'active');
          currentStep = 'build';

          await sleep(500);
          addMessage('bot', '‚úÖ Design phase complete! I\'ve created the technical specifications.');

          await sleep(800);
          addMessage('bot', 'Ready to build your application?', {
            type: 'action',
            content: `
              <div style="margin-top: 12px;">
                <button class="btn-primary" onclick="handleBuild()">üöÄ Start Building</button>
              </div>
            `
          });
        }
      } catch (error) {
        addMessage('bot', `Design error: ${error.message}`);
      }
    }

    async function handleBuild() {
      addMessage('user', 'Yes, let\'s build it!');
      addMessage('bot', 'Building your application now... This may take a minute.');

      try {
        // Execute infrastructure phase
        await fetch('/api/workflow/execute-phase', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            workflowId: workflowId,
            phase: 'infrastructure'
          })
        });

        await sleep(1000);

        // Execute code generation phase
        const response = await fetch('/api/workflow/execute-phase', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            workflowId: workflowId,
            phase: 'code'
          })
        });

        const data = await response.json();

        if (data.success) {
          conversationState.codeGenerated = true;
          updateProgress('build', 'complete');
          updateProgress('review', 'active');
          currentStep = 'review';

          // Update preview
          updatePreview(data.result);

          await sleep(500);
          addMessage('bot', 'üéâ Your application is ready! Check out the preview on the right.');

          await sleep(1000);
          addMessage('bot', 'You can download the code or request changes.', {
            type: 'action',
            content: `
              <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                <button class="btn-primary" onclick="downloadCode()">üì• Download Code</button>
                <button class="btn-secondary" onclick="requestChanges()">‚úèÔ∏è Request Changes</button>
                <button class="btn-secondary" onclick="startOver()">üîÑ Start Over</button>
              </div>
            `
          });

          updateProgress('review', 'complete');
        }
      } catch (error) {
        addMessage('bot', `Build error: ${error.message}`);
      }
    }

    function updatePreview(htmlCode) {
      const container = document.getElementById('previewContainer');

      // Clean the code
      let cleanCode = htmlCode.replace(/```html\n/g, '').replace(/```\n/g, '').replace(/```/g, '');
      const htmlMatch = cleanCode.match(/<!DOCTYPE[\s\S]*<\/html>/i);
      if (htmlMatch) {
        cleanCode = htmlMatch[0];
      }

      container.innerHTML = `
        <div class="preview-frame-wrapper ${currentDevice}">
          <iframe class="preview-frame" id="previewFrame"></iframe>
        </div>
      `;

      const iframe = document.getElementById('previewFrame');
      const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
      iframeDoc.open();
      iframeDoc.write(cleanCode);
      iframeDoc.close();
    }

    function setDevice(device) {
      currentDevice = device;
      document.querySelectorAll('.device-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`btn-${device}`).classList.add('active');

      const wrapper = document.querySelector('.preview-frame-wrapper');
      if (wrapper) {
        wrapper.className = `preview-frame-wrapper ${device}`;
      }
    }

    function downloadCode() {
      addMessage('user', 'Download the code');
      addMessage('bot', 'Preparing your download...');

      // Implement download logic
      window.open('/controlled', '_blank');
    }

    async function requestChanges() {
      addMessage('user', 'I\'d like to make some changes');

      await sleep(500);
      addMessage('bot', 'No problem! I can help you refine the application. What would you like to change?');

      await sleep(300);
      addMessage('bot', 'You can describe the changes you want, and I\'ll update the code for you. Try to be specific about what you\'d like to add, remove, or modify.');

      // Enable modification mode
      conversationState.canModify = true;
      currentStep = 'modify';
    }

    function startOver() {
      if (confirm('Start over? This will clear your current project.')) {
        location.reload();
      }
    }

    function addMessage(sender, text, options = {}) {
      const chatArea = document.getElementById('chatArea');
      const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}`;

      const avatar = sender === 'bot' ? 'ü§ñ' : 'üë§';

      let content = text;
      if (options.content) {
        content += options.content;
      }

      messageDiv.innerHTML = `
        <div class="message-avatar ${sender}">${avatar}</div>
        <div class="message-content">
          <div class="message-text">${content}</div>
          <div class="message-time">${time}</div>
        </div>
      `;

      chatArea.appendChild(messageDiv);
      chatArea.scrollTop = chatArea.scrollHeight;
    }

    function updateProgress(step, status) {
      const stepEl = document.getElementById(`step-${step}`);
      if (stepEl) {
        stepEl.className = `progress-step ${status}`;
      }
    }

    async function handleModification(message) {
      await sleep(800);
      addMessage('bot', 'I understand you want to: "' + message + '"');

      await sleep(1000);
      addMessage('bot', 'Let me regenerate the code with your requested changes...');

      // In a real implementation, you would call the AI API here to modify the code
      await sleep(2000);

      addMessage('bot', '‚úÖ I\'ve updated the application with your changes! Check the preview on the right.');

      await sleep(500);
      addMessage('bot', 'What do you think? Need any more adjustments?', {
        type: 'action',
        content: `
          <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
            <button class="btn-primary" onclick="downloadCode()">üì• Download Code</button>
            <button class="btn-secondary" onclick="requestChanges()">‚úèÔ∏è More Changes</button>
            <button class="btn-secondary" onclick="currentStep='review'">‚úì Looks Perfect</button>
          </div>
        `
      });
    }

    async function handleReviewChat(message) {
      // Handle general questions and modifications after the app is complete
      if (message.toLowerCase().includes('change') || message.toLowerCase().includes('modify') ||
          message.toLowerCase().includes('add') || message.toLowerCase().includes('update')) {
        currentStep = 'modify';
        await handleModification(message);
      } else {
        await sleep(500);
        addMessage('bot', 'I\'m here to help! You can ask me to make changes, download the code, or start a new project.');
      }
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }
  </script>
</body>
</html>
